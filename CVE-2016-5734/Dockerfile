FROM ubuntu:14.04
MAINTAINER Larry Xi "larrycompress@gmail"

# update
RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list \
    && apt-get update -yqq \
    && apt-get upgrade -yqq
# install apache2
RUN apt-get install -yqq apache2 apache2-dev

# install mysql
RUN apt-get install -yqq mysql-server mysql-client \
    && service mysql start \
    && mysqladmin -u root password "123456"

# install php
COPY src/ /opt/
RUN buildDeps=" \ 
        build-essential \
        unzip \
        libcurl4-openssl-dev \
        libedit-dev \
        libsqlite3-dev \
        libssl-dev \
        libxml2-dev \
      " \
    && apt-get install -y $buildDeps --no-install-recommends && rm -rf /var/lib/apt/lists/* \
    && cd /opt/ && unzip phpmyadmin-RELEASE_4_4_15_6.zip -d /var/www/html/ \
    && tar jxf php-5.4.0.tar.bz2 && cd php-5.4.0/ \
    && cat ../txtbgxGXAvz4N.txt | patch -p0 \
    && ./configure \
           --with-apxs2 \
           --enable-ftp \
           --enable-mbstring \
           --with-curl \
           --with-openssl \
           --with-zlib \
           --with-libedit \
           --with-mysql \
           --enable-embedded-mysqli \
    && make \
    && make install \
    && make clean \
    && echo 'AddHandler application/x-httpd-php .php' >> /etc/apache2/apache2.conf 

# init
RUN mv /opt/poc/ /var/www/html/ \
    && mv /opt/start.sh / \
    && chmod +x /start.sh \
    && rm -fr /opt/*

EXPOSE 80
CMD ["/start.sh"]
